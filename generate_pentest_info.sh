#!/usr/bin/env bash

echo "Retrieving credentials from 'paas-pass pentest/credentials.sh'. Be sure that you are in the right branch"
eval $(paas-pass pentest/credentials.sh)

DEPLOY_ENV=pentest1
eval $(make dev showenv DEPLOY_ENV=pentest1)

USERS_GPG_IDS=""

CF_ADMIN_PASSWORD=$(aws s3 cp s3://${DEPLOY_ENV}-state/cf-secrets.yml -  | awk '/uaa_admin_password/ {print $2}')

rm -f  /tmp/encryptme
mkfifo /tmp/encryptme

gpg -a -e $((cat .gpg-id ; echo "${USERS_GPG_IDS}") | xargs -n1 echo --recipient | xargs) < /tmp/encryptme > pentest_info.gpg &

cat <<EOF | tee /tmp/encryptme
Environment details for the Gov PaaS enviroment '$DEPLOY_ENV'

AWS account
-----------

 * Login URL: ${AWS_LOGIN_URL}
 * username: ${AWS_USER_NAME}
 * Password: ${AWS_PASSWORD}

Shell variables
--------------

    #---- 8< -------- 8< -------- 8< -------- 8< -------- 8< ----
    # AWS related
    export AWS_LOGIN_URL=${AWS_LOGIN_URL}
    export AWS_USER_NAME=${AWS_USER_NAME}
    export AWS_PASSWORD=${AWS_PASSWORD}

    export AWS_ACCOUNT=${AWS_ACCOUNT}
    export AWS_ACCOUNT_NAME=${AWS_ACCOUNT_NAME}
    export AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
    export AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}


    # Base CF
    export DEPLOY_ENV=${DEPLOY_ENV}
    export CONCOURSE_ATC_USER=${CONCOURSE_ATC_USER}
    export CONCOURSE_ATC_PASSWORD=${CONCOURSE_ATC_PASSWORD}
    export CONCOURSE_URL=${CONCOURSE_URL}
    export CONCOURSE_IP=${CONCOURSE_IP}

    # CF API and admin user
    export API_ENDPOINT=${API_ENDPOINT}
    export CF_ADMIN_USER=admin
    export CF_ADMIN_PASSWORD=${CF_ADMIN_PASSWORD}

    # Misc
    export LOGSEARCH_URL=${LOGSEARCH_URL}
    export KIBANA_ADMIN_USER=admin
    export KIBANA_ADMIN_PASSWORD=${KIBANA_ADMIN_PASSWORD}

    export GRAFANA_URL=${GRAFANA_URL}
    export GRAFANA_ADMIN_USER=admin
    export GRAFANA_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD}

    export GRAPHITE_URL=${GRAPHITE_URL}

    export UAA_ADMIN_PASSWORD=${UAA_ADMIN_PASSWORD}
    #---- 8< -------- 8< -------- 8< -------- 8< -------- 8< ----

How to retrieve other credentials:

    aws s3 cp s3://${DEPLOY_ENV}-state/cf-secrets.yml -

Start point
----------

 * Developer docs: https://government-paas-developer-docs.readthedocs.io/en/latest/
 * Project team manual https://government-paas-team-manual.readthedocs.io/en/latest/
 * Project README with some paas developer and usage instructions: https://github.com/alphagov/paas-cf

About autodelete
-----------------

Our environments are configured to be partly automatically deleted at nights, in order to save costs.

You can redeploy the environment by rerunning this job (click on the + in the top-right): ${CONCOURSE_URL}/teams/main/pipelines/create-bosh-cloudfoundry/jobs/cf-deploy

Otherwise, you can disable the autodelete by "pausing" the autodelete job (click pause icon it top-left): https://deployer.pentest1.dev.cloudpipeline.digital/teams/main/pipelines/autodelete-cloudfoundry/jobs/delete

EOF

wait
